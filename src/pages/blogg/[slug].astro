---
import MainLayout from '../../layouts/MainLayout.astro';
import { getPosts } from '../../lib/wordpress';
import type { Post } from '../../lib/wordpress';

export const prerender = false;

export async function getStaticPaths() {
  try {
    const posts = await getPosts(1, 100);
    return posts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error('Error fetching posts for static paths:', error);
    return [];
  }
}

let post: Post | null = null;
let error: string | null = null;

if (Astro.props.post) {
  post = Astro.props.post;
} else {
  try {
    const { slug } = Astro.params;
    const posts = await getPosts(1, 100);
    post = posts.find(p => p.slug === slug) || null;

    if (!post) {
      error = 'Kunde inte hitta inlägget';
    }
  } catch (e) {
    console.error('Fel vid hämtning av nyhet:', e);
    error = e instanceof Error ? e.message : 'Ett okänt fel inträffade';
  }
}

// Funktion för att ta bort första bilden från innehållet om det matchar featured image
function processContent(content: string, featuredImageUrl: string | undefined): string {
  if (!featuredImageUrl || !content) return content;
  
  // Normalisera featured image URL
  const normalizeUrl = (url: string) => {
    return url
      .replace(/^https?:\/\/[^\/]+/, '') // Remove domain
      .replace(/\?.+$/, '') // Remove query parameters
      .replace(/-\d+x\d+\./, '.') // Remove WordPress image size suffixes
      .replace(/\/$/, ''); // Remove trailing slash
  };

  const normalizedFeaturedUrl = normalizeUrl(featuredImageUrl);
  
  // Ta bort både figure och img taggar som matchar
  const figureRegex = /<figure[^>]*>.*?<img[^>]+src="([^"]+)"[^>]*>.*?<\/figure>/g;
  const imgRegex = /<img[^>]+src="([^"]+)"[^>]*>/g;
  
  // Först försök ta bort figure taggar
  let modified = false;
  content = content.replace(figureRegex, (match, src) => {
    if (normalizeUrl(src) === normalizedFeaturedUrl) {
      modified = true;
      return '';
    }
    return match;
  });
  
  // Om ingen figure togs bort, försök ta bort enskilda img taggar
  if (!modified) {
    content = content.replace(imgRegex, (match, src) => {
      if (normalizeUrl(src) === normalizedFeaturedUrl) {
        return '';
      }
      return match;
    });
  }
  
  return content.trim();
}

// Kontrollera om första bilden i innehållet är featured image
function hasImageInContent(content: string): boolean {
  const imgRegex = /<img[^>]+src="[^"]+"[^>]*>/;
  return imgRegex.test(content);
}

// Bestäm om vi ska visa featured image
const showFeaturedImage = post && post.featuredImage && !hasImageInContent(post.content.rendered);

const processedContent = post ? processContent(post.content.rendered, post.featuredImage) : '';
---

<MainLayout title={post ? `${post.title.rendered} | FlowLearn` : 'Inlägg hittades inte | FlowLearn'}>
  <article class="mx-auto max-w-2xl lg:max-w-5xl px-6 py-16">
    {error && (
      <div class="text-center py-16">
        <h1 class="text-2xl font-bold text-white mb-4">
          {error}
        </h1>
        <p class="text-zinc-400 mb-8">
          Inlägget kunde inte hittas eller har tagits bort.
        </p>
        <a 
          href="/blogg" 
          class="text-primary hover:text-primary-hover transition-colors"
        >
          Gå till bloggsidan
        </a>
      </div>
    )}

    {post && (
      <>
        <header class="mb-8">
          <time 
            datetime={post.date} 
            class="text-sm leading-6 text-zinc-500"
          >
            {new Date(post.date).toLocaleDateString('sv-SE', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
          <h1 class="mt-2 text-3xl font-bold tracking-tight text-white sm:text-4xl">
            {post.title.rendered}
          </h1>
        </header>

        {showFeaturedImage && (
          <img
            src={post.featuredImage}
            alt={post.title.rendered}
            class="aspect-[16/9] w-full rounded-2xl bg-zinc-100 object-cover dark:bg-zinc-800 mb-8"
          />
        )}

        <div 
          class="prose prose-lg prose-invert prose-zinc max-w-none"
          set:html={post.content.rendered} 
        />

        <div class="mt-12 pt-8 border-t border-zinc-700/40">
          <a 
            href="/blogg" 
            class="text-primary hover:text-primary-hover transition-colors flex items-center gap-2"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m12 19-7-7 7-7"/>
              <path d="M19 12H5"/>
            </svg>
            Tillbaka till alla inlägg
          </a>
        </div>
      </>
    )}
  </article>
</MainLayout>

<style>
  :global(.prose h1, .prose h2, .prose h3, .prose h4) {
    color: theme(colors.zinc.100);
    font-weight: 600;
    margin-top: 2em;
    margin-bottom: 1em;
  }
  
  :global(.prose p, .prose li) {
    color: theme(colors.zinc.400);
    line-height: 1.75;
  }

  :global(.prose a) {
    color: theme(colors.primary.DEFAULT);
    text-decoration: none;
  }

  :global(.prose a:hover) {
    color: theme(colors.primary.hover);
  }

  :global(.prose img) {
    border-radius: theme(borderRadius.lg);
    margin-top: 2em;
    margin-bottom: 2em;
  }

  :global(.prose blockquote) {
    border-left-color: theme(colors.zinc.700);
    color: theme(colors.zinc.400);
  }

  :global(.prose code) {
    background-color: theme(colors.zinc.800);
    color: theme(colors.zinc.200);
    padding: 0.2em 0.4em;
    border-radius: theme(borderRadius.sm);
  }
</style>
