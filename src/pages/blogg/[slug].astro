---
import MainLayout from '../../layouts/MainLayout.astro';
import { getPosts } from '../../lib/wordpress';
import type { Post } from '../../lib/wordpress';

export async function getStaticPaths() {
  try {
    const posts = await getPosts();
    return posts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error('Error fetching posts for static paths:', error);
    return [];
  }
}

const { post } = Astro.props;

// Funktion för att ta bort första bilden från innehållet om det matchar featured image
function processContent(content: string, featuredImageUrl: string | undefined): string {
  if (!featuredImageUrl || !content) return content;
  
  // Normalisera featured image URL
  const normalizeUrl = (url: string) => {
    return url
      .replace(/^https?:\/\/[^\/]+/, '') // Remove domain
      .replace(/\?.+$/, '') // Remove query parameters
      .replace(/-\d+x\d+\./, '.') // Remove WordPress image size suffixes
      .replace(/\/$/, ''); // Remove trailing slash
  };

  const normalizedFeaturedUrl = normalizeUrl(featuredImageUrl);
  
  // Ta bort både figure och img taggar som matchar
  const figureRegex = /<figure[^>]*>.*?<img[^>]+src="([^"]+)"[^>]*>.*?<\/figure>/g;
  const imgRegex = /<img[^>]+src="([^"]+)"[^>]*>/g;
  
  // Först försök ta bort figure taggar
  let modified = false;
  content = content.replace(figureRegex, (match, src) => {
    if (normalizeUrl(src) === normalizedFeaturedUrl) {
      modified = true;
      return '';
    }
    return match;
  });
  
  // Om ingen figure togs bort, försök ta bort enskilda img taggar
  if (!modified) {
    content = content.replace(imgRegex, (match, src) => {
      if (normalizeUrl(src) === normalizedFeaturedUrl) {
        return '';
      }
      return match;
    });
  }
  
  return content.trim();
}

// Kontrollera om första bilden i innehållet är featured image
function hasImageInContent(content: string): boolean {
  const imgRegex = /<img[^>]+src="[^"]+"[^>]*>/;
  return imgRegex.test(content);
}

// Bestäm om vi ska visa featured image
const showFeaturedImage = post && post.featuredImage && !hasImageInContent(post.content.rendered);

const processedContent = post ? processContent(post.content.rendered, post.featuredImage) : '';
---

<MainLayout title={`${post.title.rendered} | Flowlearn`}>
  <article class="mx-auto max-w-2xl lg:max-w-5xl px-6 py-16">
    {!post && (
      <div class="text-center py-16">
        <h1 class="text-2xl font-bold text-white mb-4">
          Inlägget kunde inte hittas
        </h1>
        <p class="text-zinc-400 mb-8">
          Inlägget kunde inte hittas eller har tagits bort.
        </p>
        <a 
          href="/blogg" 
          class="text-primary hover:text-primary-hover transition-colors"
        >
          Gå till bloggsidan
        </a>
      </div>
    )}

    {post && (
      <>
        <header class="mb-8">
          <time 
            datetime={post.date} 
            class="text-sm leading-6 text-zinc-500"
          >
            {new Date(post.date).toLocaleDateString('sv-SE', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
          <h1 class="mt-2 text-3xl font-bold tracking-tight text-white sm:text-4xl">
            {post.title.rendered}
          </h1>
        </header>

        {showFeaturedImage && (
          <img
            src={post.featuredImage}
            alt={post.title.rendered}
            class="aspect-[16/9] w-full rounded-2xl bg-zinc-100 object-cover dark:bg-zinc-800 mb-8"
          />
        )}

        <div 
          class="prose prose-lg prose-invert prose-zinc max-w-none"
          set:html={post.content.rendered} 
        />

        <!-- Delningslänkar -->
        <div class="mt-8 pt-6 border-t border-zinc-700/40">
          <div class="mb-4">
            <h3 class="text-zinc-200 text-sm font-medium mb-3">Dela detta inlägg</h3>
            <div class="flex gap-6">
              <!-- Facebook -->
              <a 
                href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="text-zinc-400 hover:text-[#1877F2] transition-colors p-2"
                aria-label="Dela på Facebook"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
                </svg>
              </a>
              
              <!-- Twitter/X -->
              <a 
                href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(Astro.url.href)}&text=${encodeURIComponent(post.title.rendered)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="text-zinc-400 hover:text-zinc-100 transition-colors p-2"
                aria-label="Dela på Twitter/X"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"></path>
                </svg>
              </a>
              
              <!-- LinkedIn -->
              <a 
                href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(Astro.url.href)}&title=${encodeURIComponent(post.title.rendered)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="text-zinc-400 hover:text-[#0A66C2] transition-colors p-2"
                aria-label="Dela på LinkedIn"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                  <rect x="2" y="9" width="4" height="12"></rect>
                  <circle cx="4" cy="4" r="2"></circle>
                </svg>
              </a>
              
              <!-- Kopiera länk -->
              <button 
                id="copy-link-button"
                class="text-zinc-400 hover:text-primary transition-colors p-2"
                aria-label="Kopiera länk"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Tillbaka-länk -->
          <div class="mt-6">
            <a 
              href="/blogg" 
              class="text-primary hover:text-primary-hover transition-colors flex items-center gap-2"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 19-7-7 7-7"/>
                <path d="M19 12H5"/>
              </svg>
              Tillbaka till alla inlägg
            </a>
          </div>
        </div>
      </>
    )}
  </article>
</MainLayout>

<style>
  :global(.prose h1, .prose h2, .prose h3, .prose h4) {
    color: theme(colors.zinc.100);
    font-weight: 600;
    margin-top: 2em;
    margin-bottom: 1em;
  }
  
  :global(.prose p, .prose li) {
    color: theme(colors.zinc.400);
    line-height: 1.75;
  }

  :global(.prose a) {
    color: theme(colors.primary.DEFAULT);
    text-decoration: none;
  }

  :global(.prose a:hover) {
    color: theme(colors.primary.hover);
  }

  :global(.prose img) {
    border-radius: theme(borderRadius.lg);
    margin-top: 2em;
    margin-bottom: 2em;
  }

  :global(.prose blockquote) {
    border-left-color: theme(colors.zinc.700);
    color: theme(colors.zinc.400);
  }

  :global(.prose code) {
    background-color: theme(colors.zinc.800);
    color: theme(colors.zinc.200);
    padding: 0.2em 0.4em;
    border-radius: theme(borderRadius.sm);
  }
</style>

<script>
  // Add background to header when scrolling
  const header = document.querySelector('header');
  const handleScroll = () => {
    if (window.scrollY > 50) {
      header?.classList.add('bg-slate-900/80', 'border-b', 'border-slate-700/80', 'backdrop-blur-sm');
    } else {
      header?.classList.remove('bg-slate-900/80', 'border-b', 'border-slate-700/80', 'backdrop-blur-sm');
    }
  };

  window.addEventListener('scroll', handleScroll);
  handleScroll(); // Initial check
  
  // Kopiera länk-funktionalitet
  const copyLinkButton = document.getElementById('copy-link-button');
  if (copyLinkButton) {
    copyLinkButton.addEventListener('click', () => {
      // Kopiera aktuell URL till urklipp
      navigator.clipboard.writeText(window.location.href)
        .then(() => {
          // Visuell feedback
          const originalSvg = copyLinkButton.innerHTML;
          copyLinkButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
            </svg>
          `;
          copyLinkButton.classList.add('text-green-500');
          
          // Återställ efter 2 sekunder
          setTimeout(() => {
            copyLinkButton.innerHTML = originalSvg;
            copyLinkButton.classList.remove('text-green-500');
          }, 2000);
        })
        .catch(err => {
          console.error('Kunde inte kopiera länk:', err);
        });
    });
  }
</script>
